<div class="game-environment">
  <button class="hamburger-btn" (click)="toggleMenu()" aria-label="Menu">
    <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </button>
  
  @if (isMenuOpen()) {
    <div class="menu-overlay">
      <button class="close-menu-btn" (click)="toggleMenu()">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      
      <nav class="main-nav">
        <a class="nav-item" 
        routerLink="/potong" 
        routerLinkActive="active" 
        [routerLinkActiveOptions]="{exact: true}"
        (click)="toggleMenu()">
        <span class="text">DAILY SHAPE</span>
      </a>
      
      <a class="nav-item" 
      routerLink="/potong/sandbox" 
      routerLinkActive="active"
      (click)="toggleMenu()">
      <span class="text">SANDBOX</span>
    </a>
    
    <a class="nav-item locked">
      <span class="text">ARCADE MODE</span>
      <span class="badge">SOON</span>
    </a>
    <a class="nav-item locked">
      <span class="text">PvP CHALLENGE</span>
      <span class="badge">SOON</span>
    </a>
    
    <div class="nav-divider"></div>
    
    <a class="nav-item action" (click)="openInstructions()">
      <span class="text">HOW TO PLAY</span>
    </a>
  </nav>
</div>
}

<div class="logo-container">
  <h1 class="sliced-logo" data-text="POTONG">POTONG</h1>
</div>

<header class="game-hud">
  @if (mode() === 'sandbox') {
    <div class="stat-badge">
      <span class="label">ROUNDS</span>
      <span class="value">{{ roundsPlayed() }}</span>
    </div>
    <div class="stat-badge">
      <span class="label">LAST CUT</span>
      <span class="value">{{ lastCutText() }}</span>
    </div>
    <div class="stat-badge">
      <span class="label">BEST CUT</span>
      <span class="value highlight-gold">{{ bestCutText() }}</span>
    </div>
    <div class="stat-badge">
      <span class="label">SCORE</span>
      <span class="value">{{ lastScore() !== null ? lastScore() : '--' }}</span>
    </div>
    <div class="stat-badge">
      <span class="label">AVG</span>
      <span class="value">{{ avgScore() !== null ? avgScore() : '--' }}</span>
    </div>
  } 
  @else {
    <div class="stat-badge">
      <span class="label">DATE</span>
      <span class="value">{{ dailyDate() }}</span>
    </div>
    <div class="stat-badge">
      <span class="label">STREAK</span>
      <span class="value highlight-gold">{{ dailyStreak() }} ðŸ”¥</span>
    </div>
    <div class="stat-badge">
      <span class="label">BEST CUT</span>
      <span class="value highlight-gold">{{ dailyBestCutText() }}</span>
    </div>
    <div class="stat-badge">
      <span class="label">SCORE</span>
      <span class="value">{{ dailyScore() !== null ? dailyScore() : '--' }}</span>
    </div>
    <div class="stat-badge">
      <span class="label">AVG</span>
      <span class="value">{{ dailyAvgScore() !== null ? dailyAvgScore() : '--' }}</span>
    </div>
  }
</header>

<div class="canvas-wrapper">
  
  <svg 
  #gameCanvas
  [attr.viewBox]="'0 0 ' + VIEWBOX_SIZE + ' ' + VIEWBOX_SIZE"
  preserveAspectRatio="xMidYMid meet"
  class="game-canvas"
  (pointerdown)="onPointerDown($event)"
  (pointermove)="onPointerMove($event)"
  (pointerup)="onPointerUp($event)"
  (pointercancel)="onPointerUp($event)">
  
  <defs>
    <filter id="neon-glow" x="-20%" y="-20%" width="140%" height="140%">
      <feGaussianBlur stdDeviation="15" result="blur" />
      <feMerge>
        <feMergeNode in="blur" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>
    
    <filter id="laser-glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="12" result="softGlow" />
      <feGaussianBlur stdDeviation="3" in="SourceGraphic" result="hardGlow" />
      <feMerge>
        <feMergeNode in="softGlow" />
        <feMergeNode in="hardGlow" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>
    
    <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
      <path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(129, 140, 248, 0.15)" stroke-width="1"/>
    </pattern>
  </defs>
  
  <rect width="100%" height="100%" fill="url(#grid)" />
  
  @if (!splitPieces()) {
    <polygon 
    [attr.points]="pointsString()" 
    [attr.key]="shapeId()"
    class="target-shape animate-entrance" 
    filter="url(#neon-glow)"
    />
  } @else if (splitPieces() && pieceStats()) {
    <g class="split-group" filter="url(#neon-glow)">
      
      <g class="drift-group piece-a" [class.is-drifting]="isDrifting()" [style.transform]="'translate(' + driftOffsets().offsetA.x + 'px, ' + driftOffsets().offsetA.y + 'px)'">
        
        <polygon [attr.points]="getPointsString(splitPieces()!.pieceA)" class="target-shape" />
        
        <text 
        [attr.x]="pieceStats()!.pieceA.centroid.x" 
        [attr.y]="pieceStats()!.pieceA.centroid.y" 
        class="score-text">
        {{ pieceStats()!.pieceA.percent }}%
      </text>
    </g>
    
    <g class="drift-group piece-b" [class.is-drifting]="isDrifting()" [style.transform]="'translate(' + driftOffsets().offsetB.x + 'px, ' + driftOffsets().offsetB.y + 'px)'">
      
      <polygon [attr.points]="getPointsString(splitPieces()!.pieceB)" class="target-shape" />
      
      <text 
      [attr.x]="pieceStats()!.pieceB.centroid.x" 
      [attr.y]="pieceStats()!.pieceB.centroid.y" 
      class="score-text">
      {{ pieceStats()!.pieceB.percent }}%
    </text>
  </g>
  
</g>
}

@if (startPoint() && currentPoint()) {
  <g class="slash-layer">
    <line 
    [attr.x1]="startPoint()?.x" 
    [attr.y1]="startPoint()?.y" 
    [attr.x2]="currentPoint()?.x" 
    [attr.y2]="currentPoint()?.y" 
    class="laser-cut"
    [class.drawing]="isDrawing()"
    [class.completed]="cutCompleted()"
    filter="url(#laser-glow)"
    />
    
    @if (isDrawing()) {
      <circle 
      [attr.cx]="startPoint()?.x" 
      [attr.cy]="startPoint()?.y" 
      r="8" 
      class="slash-reticle"
      />
    }
  </g>
}
</svg>
@if (cutCompleted() && isAutoNext() && autoNextProgressDuration() > 0) {
  <div class="auto-next-bar" 
  [style.--duration]="autoNextProgressDuration() + 'ms'">
</div>
}
</div>

@if (showCelebration()) {
  <div class="celebration-overlay">
    
    <div class="celebration-text" 
    [class.is-perfect]="celebrationTier() === 'perfect'"
    [class.is-almost]="celebrationTier() === 'almost'"
    [class.is-clown]="celebrationTier() === 'standard'">
    {{ celebrationText() }}
  </div>
  
  @for (p of particles(); track p.id) {
    <div class="particle"
    [style.background-color]="p.emoji ? 'transparent' : p.color"
    [style.--tx]="p.tx + 'px'"
    [style.--ty]="p.ty + 'px'"
    [style.--rot]="p.rot + 'deg'"
    [style.--scale]="p.scale"
    [style.--duration]="p.duration + 's'"
    [style.--delay]="p.delay + 's'">
    
    @if (p.emoji) {
      <span class="particle-emoji">{{ p.emoji }}</span>
    }
  </div>
}
</div>
}

<div class="controls">
  @if (mode() === 'sandbox') {
    <div class="primary-actions"> 
      <button class="auto-next-btn" [class.active]="isAutoNext()" (click)="toggleAutoNext()">
        <span class="toggle-label">AUTO NEXT</span>
      </button>
      
      <button #initBtn class="action-btn" [disabled]="!cutCompleted() || isAutoNext()"
      [class.ready-pulse]="cutCompleted() && !isAutoNext()" 
      (click)="generateRandomShape(); initBtn.blur()">
      <span class="btn-text">NEXT SHAPE</span>
    </button>
  </div>
} @else {
  @if (cutCompleted()) {
    <div class="primary-actions">
      <button class="action-btn" 
      [class.copied-state]="shareCopied()" 
      [class.ready-pulse]="!shareCopied()"
      [cdkCopyToClipboard]="dailyShareString()"
      (cdkCopyToClipboardCopied)="onShareCopied($event)">
      <span class="btn-text">{{ shareText() }}</span>
    </button>
  </div>
}
}
</div>

</div>

@if (showInstructions()) {
  <div class="modal-overlay">
    <div class="instruction-modal">
      <h2>HOW TO PLAY</h2>
      
      <p class="flavor-text">
        In Malay, <em>"Potong"</em> means to cut or slice.
      </p>
      
      <p>
        Slice the shape in half (50.0 / 50.0).<br>
        The closer you are to perfectly half, the higher your score.
      </p>
      
      <div class="rubric-container">
        <h3>SCORING CURVE</h3>
        <svg viewBox="0 0 400 200" class="rubric-graph">
          <line x1="50" y1="20" x2="380" y2="20" class="grid-line" />
          <line x1="50" y1="100" x2="380" y2="100" class="grid-line" />
          <line x1="50" y1="180" x2="380" y2="180" class="grid-line" />
          
          <line x1="50" y1="20" x2="50" y2="180" class="axis" />
          <line x1="50" y1="180" x2="380" y2="180" class="axis" />
          
          <text x="40" y="25" class="axis-label y-axis">100</text>
          <text x="40" y="105" class="axis-label y-axis">50</text>
          <text x="40" y="180" class="axis-label y-axis">0</text>
          
          <text x="50" y="195" class="axis-label x-axis">Perfect</text>
          <text x="215" y="195" class="axis-label x-axis">25% Off</text>
          <text x="380" y="195" class="axis-label x-axis">Miss</text>
          
          <path d="M 50 20 C 65 50, 180 160, 314 180 L 380 180" class="scoring-curve" />
          
          <circle cx="50" cy="20" r="5" class="perfect-dot" />
        </svg>
      </div>
      
      <button class="action-btn" (click)="closeInstructions()">START POTONG</button>
    </div>
  </div>
}